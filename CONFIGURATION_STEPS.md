# ⚙️ V2.3.0 配置执行清单

**配置开始时间:** 2025年12月12日
**配置阶段:** 环境初始化
**目标:** 10分钟内完成所有配置
**难度:** ⭐ (极简单)

---

## 🎯 配置步骤一览

```
Step 1️⃣  → 替换环境ID (2分钟)
Step 2️⃣  → 部署云函数 (2分钟)
Step 3️⃣  → 创建数据库集合 (3分钟)
Step 4️⃣  → 验证连接 (2分钟)
Step 5️⃣  → 测试游戏 (1分钟)

总耗时: 10分钟 ✓
```

---

## 📋 配置前准备

### 需要准备的信息

在开始前，请准备以下信息（都很容易获取）：

```
□ 微信开发者平台账户
  └─ 已登录: https://mp.weixin.qq.com

□ 云开发环境
  └─ 已创建或即将创建

□ 微信开发者工具
  └─ 版本 v1.06 或更高
  └─ 项目已打开: d:\shouqibao\miniprogram
```

---

## 🔧 STEP 1: 替换环境ID (2分钟)

### 📍 位置
```
文件: miniprogram/app.js
行数: 第12-13行
```

### 📝 操作步骤

**1. 打开文件**
```
VS Code → 打开 miniprogram/app.js
```

**2. 找到这一行 (使用 Ctrl+F 搜索)**
```javascript
const envId = 'shouqibao-prod-xxxxx'; // TODO: 替换为真实环境ID
```

**3. 替换为你的真实环境ID**

获取环境ID的步骤:
```
1. 登录微信开发者平台
   https://mp.weixin.qq.com

2. 进入 "开发管理" → "云开发"

3. 找到你的云环境

4. 复制 "环境ID"
   格式类似: console-6fl8abc1234567...

5. 粘贴到代码中
```

**修改前:**
```javascript
const envId = 'shouqibao-prod-xxxxx';
```

**修改后 (示例):**
```javascript
const envId = 'console-6fl8abc1234567';  // 用你的真实ID替换
```

### ✅ 完成标志
```
保存文件后，app.js 第12-13行有你的真实环境ID
```

### ❓ 常见问题

**Q: 环境ID在哪里看?**
```
A: 微信平台 → 开发管理 → 云开发
   → 你的环境 → 环境ID (复制按钮)
```

**Q: 环境还没创建怎么办?**
```
A: 在微信平台的"云开发"页面点击 "创建环境"
   → 填写环境名称 (shouqibao-prod)
   → 选择免费版本
   → 确认创建
```

**Q: 格式不对会怎样?**
```
A: 运行时会报 "环境ID无效" 错误
   检查ID是否完整, 没有多余空格
```

---

## 🔧 STEP 2: 部署云函数 (2分钟)

### 📍 云函数位置
```
miniprogram/cloudfunctions/login/
├── index.js (云函数代码)
└── package.json (配置文件)
```

### 📝 操作步骤

**1. 打开微信开发者工具**

**2. 在左侧项目文件树中找到**
```
cloudfunctions
└── login
```

**3. 右键点击 "login" 文件夹**
```
选择: "增量上传并部署"
```

**4. 等待上传完成**
```
底部进度栏显示 "已完成" 即可
预期时间: 30秒左右
```

### ✅ 完成标志

在微信开发者平台验证:
```
1. 登录微信平台
2. 进入 "开发管理" → "云开发" → "云函数"
3. 看到 "login" 函数列表中出现
```

### ❓ 常见问题

**Q: 没有 "增量上传" 选项?**
```
A: 检查是否右键点击的是 "login" 文件夹（不是文件）
   或更新微信开发者工具版本
```

**Q: 上传失败了?**
```
A: 1. 检查网络连接
   2. 检查微信账户权限
   3. 查看底部错误信息
   4. 重新右键选择 "增量上传"
```

**Q: 上传成功但在平台看不到?**
```
A: 刷新微信平台页面
   或等待几秒后再查看
```

---

## 🔧 STEP 3: 创建数据库集合 (3分钟)

### 📍 位置
```
微信开发者平台 → 云开发 → 数据库
```

### 📝 操作步骤

**创建第1个集合: user_data**

```
1. 进入微信平台 → 云开发 → 数据库

2. 点击 "新增集合"

3. 输入集合名: user_data

4. 创建成功后，点击 "权限"

5. 选择 "自定义安全规则"

6. 输入以下规则:
```

```json
{
  "read": "doc.userId == auth.uid",
  "write": "doc.userId == auth.uid"
}
```

```
7. 点击 "保存"
```

---

**创建第2个集合: achievements**

```
1. 点击 "新增集合"

2. 输入集合名: achievements

3. 创建成功后，点击 "权限"

4. 选择 "自定义安全规则"

5. 输入以下规则:
```

```json
{
  "read": "doc.userId == auth.uid",
  "write": "doc.userId == auth.uid"
}
```

```
6. 点击 "保存"
```

---

**创建第3个集合: leaderboard**

```
1. 点击 "新增集合"

2. 输入集合名: leaderboard

3. 创建成功后，点击 "权限"

4. 选择 "自定义安全规则"

5. 输入以下规则:
```

```json
{
  "read": "true",
  "write": "doc.userId == auth.uid"
}
```

```
6. 点击 "保存"

注意: leaderboard 的读权限是 "true" (所有人可读)
    这样排行榜才能显示给所有玩家
```

---

### ✅ 完成标志

在微信平台数据库管理中应该看到:
```
✓ user_data (权限: 自定义规则)
✓ achievements (权限: 自定义规则)
✓ leaderboard (权限: 自定义规则)
```

### ❓ 常见问题

**Q: "新增集合" 按钮在哪?**
```
A: 微信平台 → 云开发 → 数据库
   右上角的 "新增集合" 或类似按钮
```

**Q: 权限规则是什么意思?**
```
A: auth.uid = 当前用户的身份标识 (OpenID)
   doc.userId = 数据库中存储的用户ID

   user_data: 用户只能读写自己的数据
   leaderboard: 所有人可以读排行榜，但只能写自己的数据
```

**Q: 权限设错了怎么办?**
```
A: 点击集合 → "权限" → 修改规则 → 保存
```

---

## 🔧 STEP 4: 验证连接 (2分钟)

### 📍 验证位置
```
微信开发者工具 → 工具栏 → 云开发
```

### 📝 操作步骤

**1. 打开微信开发者工具**

**2. 工具栏找到 "云开发" 按钮**
```
位置: 顶部菜单栏，通常在 "预览" 附近
```

**3. 点击 "云开发"**
```
会弹出一个面板
```

**4. 在面板中输入你的环境ID**
```
之前替换在 app.js 中的那个环保境ID
```

**5. 点击 "连接"**

### ✅ 完成标志

```
出现绿色 ✓ 表示连接成功

如果连接成功，面板会显示:
  ✓ 云数据库
  ✓ 云函数
  ✓ 文件存储
  ✓ 日志
```

### ❓ 常见问题

**Q: "环境ID无效" 错误?**
```
A: 1. 检查 ID 是否完整复制
   2. 检查是否有多余空格
   3. 在微信平台确认环境是否存在
   4. 尝试重新创建环境
```

**Q: 连接超时?**
```
A: 1. 检查网络连接
   2. 稍等几秒再试
   3. 关闭工具重新打开
```

---

## 🔧 STEP 5: 测试游戏 (1分钟)

### 📝 操作步骤

**1. 在微信开发者工具中点击 "预览"**
```
快捷键: Ctrl + P
```

**2. 扫描二维码或自动打开预览**
```
小程序开始运行
```

**3. 点击出气包一次**
```
打一次游戏，得10分
```

**4. 打开开发者工具的控制台**
```
F12 或 Ctrl+I
```

### ✅ 预期输出

在控制台应该看到类似的日志:
```
✅ 云服务初始化成功
用户ID获取成功
✅ 分数已实时同步到云端
```

### ✅ 验证数据保存

**1. 回到微信平台**

**2. 进入 "数据库" → "user_data" 集合**

**3. 应该看到一条新增的记录**
```
{
  "_id": "...",
  "userId": "oFAI...xyz123",
  "totalScore": 10,
  "lastUpdateTime": "2025-12-12..."
}
```

### ❓ 常见问题

**Q: 控制台看不到成功日志?**
```
A: 1. 检查 app.js 中的环境ID是否正确
   2. 查看是否有错误信息
   3. 检查网络连接
   4. 重新刷新小程序
```

**Q: 数据没有保存到云?**
```
A: 1. 检查云函数是否已部署
   2. 检查数据库集合是否已创建
   3. 检查权限规则是否正确
   4. 查看错误信息
```

**Q: 报错 "权限不足"?**
```
A: 1. 检查权限规则中是否有 auth.uid
   2. 重新配置权限规则
   3. 在微信平台重新保存权限
   4. 重新刷新小程序
```

---

## 📊 配置完成检查清单

配置完成后，检查以下各项:

```
STEP 1 - 环境ID:
  □ miniprogram/app.js 第12行有真实环境ID
  □ 格式正确，无多余空格

STEP 2 - 云函数:
  □ 在微信平台看到 "login" 函数
  □ 函数显示为 "已部署"

STEP 3 - 数据库:
  □ 创建了 user_data 集合
  □ 创建了 achievements 集合
  □ 创建了 leaderboard 集合
  □ 每个集合都配置了权限规则

STEP 4 - 连接验证:
  □ 微信工具连接到云环境成功
  □ 看到绿色 ✓ 标志

STEP 5 - 游戏测试:
  □ 游戏能正常运行
  □ 控制台显示"初始化成功"
  □ 数据保存到云平台
```

**所有项都勾选了？** → 配置完成！🎉

---

## 🎯 完成后的效果

### 游戏现象

```
打开游戏:
  ✓ 显示欢迎界面
  ✓ 自动初始化云服务

打一次出气包:
  ✓ 得10分
  ✓ 后台自动保存到云
  ✓ 控制台显示同步日志

关闭游戏:
  ✓ 数据已保存

重新打开游戏:
  ✓ 分数自动恢复
  ✓ 从云端加载
```

### 云平台现象

```
微信平台数据库:
  ✓ user_data 中有你的用户记录
  ✓ 记录中 totalScore 是 10
  ✓ 每打一次会更新

云函数日志:
  ✓ 看到调用日志
```

---

## 📞 需要帮助?

### 如果卡在某一步

| 步骤 | 问题 | 解决方案 |
|------|------|--------|
| Step 1 | 找不到环境ID | 查看本清单 "常见问题" 小节 |
| Step 2 | 云函数上传失败 | 检查网络和工具版本 |
| Step 3 | 数据库创建失败 | 确认是否在正确的平台位置 |
| Step 4 | 连接超时 | 检查ID和网络 |
| Step 5 | 数据没保存 | 检查所有权限规则 |

### 完整问题排查

参考文档: `CLOUD_INTEGRATION_REFERENCE.md` 的 "错误排查" 部分

---

## ⏱️ 时间提醒

```
建议分配时间:

STEP 1: 2分钟  ⏱️
        └─ 找ID + 替换

STEP 2: 2分钟  ⏱️
        └─ 上传云函数

STEP 3: 3分钟  ⏱️
        └─ 创建3个集合

STEP 4: 2分钟  ⏱️
        └─ 验证连接

STEP 5: 1分钟  ⏱️
        └─ 测试游戏

总计: 10分钟 ✓
```

---

## 🎊 完成标志

当看到以下现象时，说明配置成功:

```
✅ 微信工具连接到云环境 (绿色✓)
✅ 游戏运行时控制台显示"初始化成功"
✅ 打击后看到"分数已同步"日志
✅ 在微信平台的数据库看到保存的数据
```

---

## 🚀 下一步

配置完成后:

```
1. 享受V2.3.0的所有功能
   └─ 云端数据系统 ✓
   └─ 成就自动解锁 ✓
   └─ 离线模式支持 ✓

2. 打破100次解锁第一个成就

3. 为V2.4.0排行榜做准备
```

---

**准备好开始配置了吗?**

**从 STEP 1 开始！** 🚀

**预计完成: 10分钟**
**难度: ⭐⭐ (非常简单)**
**支持: 每一步都有详细说明**
